<!DOCTYPE html>
<html>
<head>
    <title>Training - {{ module_name }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header"><i class="fas fa-shield-alt"></i> TeachMate AI</div>
            <ul class="nav-menu">
                <li><a href="/dashboard" class="nav-link"><i class="fas fa-arrow-left"></i> Back</a></li>
            </ul>
        </div>

        <div class="main-content" style="display: flex; flex-direction: column;">
            <div class="chat-wrapper" style="flex: 1;">
                <div class="chat-header">
                    <h3 style="margin: 0;">{{ module_name }}</h3>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="doubtMode">
                        <label for="doubtMode" style="margin: 0;">Doubt Mode</label>
                    </div>
                </div>

                <div id="chat-box" class="chat-area"></div>
                
                <div id="preview" style="padding: 10px; display: none; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                    <img id="imgp" style="height: 50px; border-radius: 4px; border: 1px solid #cbd5e1;">
                    <span style="color: #ef4444; cursor: pointer; margin-left: 10px; font-size: 12px;" onclick="clearImage()">Remove</span>
                </div>

                <div class="chat-input-zone">
                    <input type="file" id="fi" accept="image/*" style="display: none;" onchange="handleFile()">
                    <i class="fas fa-camera" style="font-size: 1.2em; color: #94a3b8; cursor: pointer;" onclick="document.getElementById('fi').click()"></i>
                    <input type="text" id="inp" placeholder="Type your answer or ask a doubt..." autocomplete="off">
                    <button onclick="send()" class="btn-primary" style="width: auto;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const moduleId = "{{ module_id }}";
        const ws = new WebSocket("ws://" + location.host + "/ws/" + moduleId);
        const box = document.getElementById("chat-box");
        let img64 = null;

        ws.onmessage = e => {
            const d = JSON.parse(e.data);
            const div = document.createElement("div");
            div.className = "msg ai";
            div.innerHTML = d.text.replace("AI:", "");
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        };

        function handleFile() {
            const f = document.getElementById('fi').files[0];
            if (f) {
                const r = new FileReader();
                r.onload = e => {
                    img64 = e.target.result;
                    document.getElementById('imgp').src = img64;
                    document.getElementById('preview').style.display = 'block';
                    document.getElementById('doubtMode').checked = true;
                };
                r.readAsDataURL(f);
            }
        }

        function clearImage() {
            img64 = null;
            document.getElementById('fi').value = "";
            document.getElementById('preview').style.display = 'none';
        }

        function send() {
            const t = document.getElementById("inp").value.trim();
            if (!t && !img64) return;

            const div = document.createElement("div");
            div.className = "msg user";
            div.innerHTML = t + (img64 ? `<br><img src="${img64}" style="max-height: 100px; margin-top: 5px; border-radius: 4px;">` : "");
            box.appendChild(div);

            ws.send(JSON.stringify({
                type: document.getElementById('doubtMode').checked || img64 ? "doubt" : "answer",
                text: t,
                image: img64
            }));

            document.getElementById("inp").value = "";
            if (img64) clearImage();
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>